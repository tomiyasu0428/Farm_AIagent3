# è¾²æ¥­AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å®Œå…¨ã‚¬ã‚¤ãƒ‰

## ğŸ“‹ æ¦‚è¦

**ä½œæˆæ—¥**: 2025å¹´7æœˆ26æ—¥  
**å¯¾è±¡**: è¾²æ¥­ç®¡ç†AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚·ã‚¹ãƒ†ãƒ   
**æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯**: LangChain/LangGraph + MongoDB + Google Cloud  
**ç›®çš„**: Manusã‚’å‚è€ƒã«ã—ãŸãƒãƒ«ãƒã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚·ã‚¹ãƒ†ãƒ è¨­è¨ˆã¨å®Ÿè£…ã‚¬ã‚¤ãƒ‰

---

## ğŸ¯ ç¬¬1éƒ¨: ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆæ€æƒ³

### 1.1 Manusã‹ã‚‰å­¦ã¶ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆè¨­è¨ˆã®åŸå‰‡

å…ˆé€²çš„ãªAIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã€ŒManusã€ã®åˆ†æã‹ã‚‰å¾—ã‚‰ã‚ŒãŸæ ¸å¿ƒçš„ãªè¨­è¨ˆåŸå‰‡ï¼š

#### **ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¿ãƒ¼ãƒ»ãƒ‘ãƒ©ãƒ€ã‚¤ãƒ **
- **å˜ä¸€LLMä¾å­˜ã®è„±å´**: è¤‡æ•°ã®ãƒ¢ãƒ‡ãƒ«ã¨ãƒ„ãƒ¼ãƒ«ã‚’å”èª¿ã•ã›ã‚‹ã€ŒæŒ‡æ®è€…ã€ã¨ã—ã¦ã®å½¹å‰²
- **ãƒãƒ«ãƒã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚·ã‚¹ãƒ†ãƒ **: è²¬å‹™åˆ†å‰²ã«ã‚ˆã‚‹å°‚é–€æ€§ã¨ä¿å®ˆæ€§ã®å‘ä¸Š
- **ãƒ¢ãƒ‡ãƒ«éä¾å­˜ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£**: å°†æ¥ã®ãƒ¢ãƒ‡ãƒ«å¤‰æ›´ã«å¯¾å¿œå¯èƒ½ãªæŸ”è»Ÿæ€§

#### **5ã¤ã®æ ¸å¿ƒæŠ€è¡“**

##### 1. KV-Cacheæœ€é©åŒ–
```
ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ§‹é€ ã®ã€Œè–åŸŸåŒ–ã€
â”œâ”€ ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®å®Œå…¨å›ºå®šåŒ–
â”œâ”€ è¿½è¨˜å°‚ç”¨ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆè¨­è¨ˆ
â””â”€ æˆ¦ç•¥çš„ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ–ãƒ¬ãƒ¼ã‚¯ãƒã‚¤ãƒ³ãƒˆé…ç½®
```

##### 2. è³¢ã„ãƒ„ãƒ¼ãƒ«ç®¡ç†
```
å‰Šé™¤ã§ã¯ãªããƒã‚¹ã‚­ãƒ³ã‚°
â”œâ”€ ã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚·ãƒ³ã«ã‚ˆã‚‹å¯è¦–æ€§åˆ¶å¾¡
â”œâ”€ æˆ¦ç•¥çš„ãƒ„ãƒ¼ãƒ«å‘½åï¼ˆãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹æ´»ç”¨ï¼‰
â””â”€ ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ—ãƒªãƒ•ã‚£ãƒ«æŠ€è¡“
```

##### 3. ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ æ´»ç”¨
```
ç„¡é™ã®å¤–éƒ¨ãƒ¡ãƒ¢ãƒª
â”œâ”€ todo.md ã«ã‚ˆã‚‹è¨ˆç”»ç®¡ç†
â”œâ”€ æ°¸ç¶šçš„ãªã‚»ãƒƒã‚·ãƒ§ãƒ³é–“ãƒ‡ãƒ¼ã‚¿ç¶­æŒ
â””â”€ AIãŒç›´æ¥èª­ã¿æ›¸ãå¯èƒ½ãªæ§‹é€ åŒ–æƒ…å ±
```

##### 4. ãƒªã‚µã‚¤ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆå¾©å”±ï¼‰æŠ€è¡“
```
æ³¨æ„æ“ä½œã«ã‚ˆã‚‹é›†ä¸­åŠ›å‘ä¸Š
â”œâ”€ é‡è¦æƒ…å ±ã®æ„å›³çš„ãªç¹°ã‚Šè¿”ã—å‚ç…§
â”œâ”€ ã‚¿ã‚¹ã‚¯ã®å„ªå…ˆé †ä½æ˜ç¢ºåŒ–
â””â”€ é•·æœŸçš„ä¸€è²«æ€§ã®ç¶­æŒ
```

##### 5. å®Ÿè·µçš„é–‹ç™ºã‚¢ãƒ—ãƒ­ãƒ¼ãƒ
```
ç¢ºç‡çš„å‹¾é…é™ä¸‹æ³•
â”œâ”€ ä»®èª¬â†’å®Ÿè£…â†’æ¤œè¨¼ã®é«˜é€Ÿã‚µã‚¤ã‚¯ãƒ«
â”œâ”€ æ®µéšçš„è¤‡é›‘æ€§ç®¡ç†
â””â”€ å°ã•ãªæ”¹å–„ã®ç©ã¿é‡ã­
```

### 1.2 è¾²æ¥­ç‰¹åŒ–ã¸ã®é©ç”¨æˆ¦ç•¥

#### **å˜ä¸€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®é™ç•Œ**
- **ãƒ„ãƒ¼ãƒ«é¸æŠå•é¡Œ**: 11å€‹ã®ãƒ„ãƒ¼ãƒ«ã«ã‚ˆã‚‹èªçŸ¥è² è·
- **å¹»è¦šãƒªã‚¹ã‚¯**: å­˜åœ¨ã—ãªã„ãƒ„ãƒ¼ãƒ«å¼•æ•°ã®ç”Ÿæˆ
- **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ä½ä¸‹**: æ¨è«–æ™‚é–“ã®å¢—å¤§

#### **ãƒãƒ«ãƒã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆè§£æ±ºç­–**
```
è²¬å‹™åˆ†å‰²ã«ã‚ˆã‚‹å°‚é–€åŒ–
â”œâ”€ TaskManagementAgent: ã‚¿ã‚¹ã‚¯æ“ä½œå°‚é–€
â”œâ”€ AgronomyAdvisorAgent: è¾²æ¥­åŠ©è¨€å°‚é–€
â”œâ”€ FarmDataQueryAgent: ãƒ‡ãƒ¼ã‚¿ç…§ä¼šå°‚é–€
â””â”€ NotificationAgent: é€šçŸ¥ç®¡ç†å°‚é–€
```

---

## ğŸ—ï¸ ç¬¬2éƒ¨: LangGraphãƒãƒ«ãƒã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### 2.1 ã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒã‚¤ã‚¶ãƒ¼ãƒ»ãƒ¯ãƒ¼ã‚«ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³

#### **ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¦‚è¦**
```
LineSupervisor (ä¸­å¤®çµ±åˆ¶)
â”œâ”€ LINEãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡ãƒ»è§£é‡ˆ
â”œâ”€ ã‚¿ã‚¹ã‚¯ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°åˆ¤æ–­
â”œâ”€ æœ€çµ‚å¿œç­”æ•´å½¢
â””â”€ çŠ¶æ…‹ç®¡ç†ãƒ»èª¿æ•´

â†“ æ¡ä»¶åˆ†å²ã‚¨ãƒƒã‚¸

ãƒ¯ãƒ¼ã‚«ãƒ¼ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆç¾¤
â”œâ”€ TaskManagementAgent
â”œâ”€ AgronomyAdvisorAgent  
â”œâ”€ FarmDataQueryAgent
â””â”€ NotificationAgent
```

#### **è©³ç´°ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆè¨­è¨ˆ**

| ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ | ä¸»è¦è²¬å‹™ | ä¸»è¦ãƒ„ãƒ¼ãƒ« | å®Ÿè£…ãƒã‚¤ãƒ³ãƒˆ |
|-------------|---------|------------|------------|
| **LineSupervisor** | ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è§£é‡ˆãƒ»ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒ»çµ±åˆ | ãªã—ï¼ˆä»–ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒãƒ„ãƒ¼ãƒ«ï¼‰ | é–¢æ•°å‘¼ã³å‡ºã—ã«ã‚ˆã‚‹ç¢ºå®Ÿãªãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚° |
| **TaskManagementAgent** | ã‚¿ã‚¹ã‚¯CRUDæ“ä½œå…¨èˆ¬ | TaskLookup, TaskUpdate, TaskCreate | é«˜é€Ÿãƒ¬ã‚¹ãƒãƒ³ã‚¹é‡è¦– |
| **AgronomyAdvisorAgent** | è¾²è–¬ãƒ»è‚¥æ–™ãƒ»å¤©å€™åˆ†æ | CropMaterial, MaterialDilution, Weather | è¤‡é›‘ãªåˆ¤æ–­ãƒ­ã‚¸ãƒƒã‚¯å®Ÿè£… |
| **FarmDataQueryAgent** | è¾²å ´ãƒ‡ãƒ¼ã‚¿ç…§ä¼š | FieldInfo, SensorData, WorkerLog | æœ€é©åŒ–ã•ã‚ŒãŸã‚¯ã‚¨ãƒªç”Ÿæˆ |
| **NotificationAgent** | ã‚¢ã‚¦ãƒˆãƒã‚¦ãƒ³ãƒ‰é€šä¿¡ | Notification | ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ |

### 2.2 ä¸­å¤®çŠ¶æ…‹ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ 

#### **AgriAgentState å®šç¾©**
```python
from typing import TypedDict, Annotated, List, Dict, Any
from langchain_core.messages import BaseMessage
import operator

class AgriAgentState(TypedDict):
    # ä¼šè©±å±¥æ­´ï¼ˆè¿½åŠ ãƒ¢ãƒ¼ãƒ‰ï¼‰
    messages: Annotated[List[BaseMessage], operator.add]
    
    # ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°åˆ¶å¾¡
    next_agent: str
    
    # ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±
    user_id: str
    thread_id: str
    
    # Manuså¼ã‚¿ã‚¹ã‚¯è¨ˆç”»ï¼ˆtodo.mdæ¨¡å€£ï¼‰
    task_plan: Dict[str, Any]
    
    # ãƒ‡ãƒãƒƒã‚°ãƒ»åˆ†æç”¨
    intermediate_steps: Annotated[List[Dict], operator.add]
    
    # æœ€çµ‚ãƒ¬ã‚¹ãƒãƒ³ã‚¹
    final_response: str
```

#### **MongoDBSaveré€£æº**
```python
from langgraph.checkpoint.mongodb import MongoDBSaver

# æ°¸ç¶šåŒ–ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ã‚¿ãƒ¼
checkpointer = MongoDBSaver(
    connection_string="mongodb://...",
    database_name="agri_ai_checkpoints"
)

# ã‚°ãƒ©ãƒ•ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚ã«æŒ‡å®š
app = workflow.compile(checkpointer=checkpointer)
```

### 2.3 LineSupervisorã®å®Ÿè£…

#### **ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãƒªãƒ³ã‚°**
```python
supervisor_system_prompt = """
ã‚ãªãŸã¯ä»¥ä¸‹ã®ãƒ¯ãƒ¼ã‚«ãƒ¼ã‹ã‚‰ãªã‚‹ãƒãƒ¼ãƒ ã‚’ç®¡ç†ã™ã‚‹ã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒã‚¤ã‚¶ãƒ¼ã§ã™: {members}

å„ãƒ¯ãƒ¼ã‚«ãƒ¼ã®å°‚é–€åˆ†é‡:
- TaskManagementAgent: è¾²ä½œæ¥­ã‚¿ã‚¹ã‚¯ã®ä½œæˆãƒ»æ›´æ–°ãƒ»ç…§ä¼š
- AgronomyAdvisorAgent: è¾²è–¬ãƒ»è‚¥æ–™ãƒ»å¤©å€™ã«åŸºã¥ãå°‚é–€çš„åŠ©è¨€
- FarmDataQueryAgent: åœƒå ´ãƒ»ã‚»ãƒ³ã‚µãƒ¼ãƒ»ä½œæ¥­å±¥æ­´ã®ä¸€èˆ¬çš„ãƒ‡ãƒ¼ã‚¿ç…§ä¼š
- NotificationAgent: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®é€šçŸ¥ãƒ»ã‚¢ãƒ©ãƒ¼ãƒˆé€ä¿¡

ä¼šè©±å±¥æ­´ã‚’è€ƒæ…®ã—ã€æ¬¡ã«ã©ã®å½¹å‰²ã‚’å‘¼ã³å‡ºã™ã¹ãã‹ã‚’åˆ¤æ–­ã—ã¦ãã ã•ã„ã€‚
ã™ã¹ã¦ã®ã‚¿ã‚¹ã‚¯ãŒå®Œäº†ã—ãŸå ´åˆã¯ 'FINISH' ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚
"""
```

#### **é–¢æ•°å‘¼ã³å‡ºã—ã«ã‚ˆã‚‹ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°**
```python
from langchain_core.pydantic_v1 import BaseModel, Field
from typing import Literal

AgentName = Literal[
    "TaskManagementAgent", 
    "AgronomyAdvisorAgent", 
    "FarmDataQueryAgent", 
    "NotificationAgent", 
    "FINISH"
]

class Route(BaseModel):
    """æ¬¡ã«å‘¼ã³å‡ºã™ã¹ããƒ¯ãƒ¼ã‚«ãƒ¼ã¾ãŸã¯å®Œäº†ã‚’é¸æŠ"""
    next: AgentName = Field(
        description="ã‚¿ã‚¹ã‚¯ã‚’å‡¦ç†ã™ã‚‹æ¬¡ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆåã€ã¾ãŸã¯'FINISH'"
    )

# LLMãƒã‚§ãƒ¼ãƒ³
supervisor_chain = (
    prompt.partial(members=", ".join(members))
    | llm.with_structured_output(Route)
)
```

### 2.4 ãƒ¯ãƒ¼ã‚«ãƒ¼ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å®Ÿè£…

#### **create_react_agentã®æ´»ç”¨**
```python
from langgraph.prebuilt import create_react_agent

# TaskManagementAgentä¾‹
task_management_tools = [task_update_tool, task_lookup_tool, task_create_tool]

task_management_agent = create_react_agent(
    llm,
    tools=task_management_tools,
    messages_modifier="ã‚ãªãŸã¯ã‚¿ã‚¹ã‚¯ç®¡ç†ã®å°‚é–€å®¶ã§ã™ã€‚"
)

# ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’ãƒ„ãƒ¼ãƒ«åŒ–
def create_agent_tool(agent_executor, name: str, description: str):
    def agent_as_tool(input_dict: dict):
        return agent_executor.invoke(input_dict)
    
    return Tool(name=name, func=agent_as_tool, description=description)
```

#### **é«˜åº¦ãªPesticideRecommendationTool**
```python
# ã‚µãƒ–ã‚°ãƒ©ãƒ•ã¨ã—ã¦ã®å®Ÿè£…
class PesticideRecommendationTool:
    async def recommend(self, field_id: str, crop_id: str) -> Dict:
        # Step 1: ãƒ‡ãƒ¼ã‚¿åé›†
        field_info = await self.field_info_tool(field_id)
        work_history = await self.work_records_lookup(field_id)
        weather = await self.weather_forecast_tool()
        available_materials = await self.crop_material_tool(crop_id)
        
        # Step 2: ãƒ­ã‚¸ãƒƒã‚¯çµ±åˆ
        candidates = self._filter_by_rotation_rules(
            available_materials, work_history
        )
        ranked = self._rank_by_weather_conditions(candidates, weather)
        
        # Step 3: æ§‹é€ åŒ–ãƒ¬ã‚¹ãƒãƒ³ã‚¹
        return {
            "recommended_material": ranked[0]["name"],
            "dilution_ratio": ranked[0]["dilution"],
            "reasoning": self._generate_reasoning(ranked[0], field_info)
        }
```

---

## ğŸ”§ ç¬¬3éƒ¨: é«˜åº¦ãªå®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³

### 3.1 Manuså¼ã€Œåå¾©ã€ãƒ‘ã‚¿ãƒ¼ãƒ³ã®å®Ÿè£…

#### **scratchpadã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³è¨­è¨ˆ**
```javascript
// MongoDB scratchpad ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³
{
  "_id": ObjectId("..."),
  "thread_id": "user_12345_session_001",
  "task_type": "weekly_planning",
  "plan": {
    "goal": "å…¨åœƒå ´ã®é€±é–“ä½œæ¥­è¨ˆç”»ã‚’ç«‹ã¦ã‚‹",
    "steps": [
      {"id": 1, "description": "Aç•‘ã®åˆ†æ", "status": "completed"},
      {"id": 2, "description": "Bç•‘ã®åˆ†æ", "status": "in_progress"},
      {"id": 3, "description": "ãƒªã‚½ãƒ¼ã‚¹çµ±åˆ", "status": "pending"}
    ]
  },
  "created_at": ISODate("..."),
  "updated_at": ISODate("...")
}
```

#### **è¨ˆç”»ç®¡ç†ãƒ•ãƒ­ãƒ¼**
```python
class TaskPlanManager:
    async def create_plan(self, thread_id: str, goal: str, steps: List[str]):
        plan_doc = {
            "thread_id": thread_id,
            "task_type": self._classify_task(goal),
            "plan": {
                "goal": goal,
                "steps": [
                    {"id": i+1, "description": step, "status": "pending"}
                    for i, step in enumerate(steps)
                ]
            },
            "created_at": datetime.now()
        }
        result = await self.collection.insert_one(plan_doc)
        return str(result.inserted_id)
    
    async def update_progress(self, plan_id: str, step_id: int, status: str):
        await self.collection.update_one(
            {"_id": ObjectId(plan_id), "plan.steps.id": step_id},
            {"$set": {"plan.steps.$.status": status, "updated_at": datetime.now()}}
        )
    
    async def inject_into_prompt(self, plan_id: str) -> str:
        plan = await self.collection.find_one({"_id": ObjectId(plan_id)})
        return f"""
ç¾åœ¨ã®ã‚¿ã‚¹ã‚¯è¨ˆç”»:
ç›®æ¨™: {plan['plan']['goal']}
é€²æ—: {self._format_progress(plan['plan']['steps'])}

ã“ã®è¨ˆç”»ã«å¾“ã£ã¦æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚
"""
```

### 3.2 è‡ªå·±ä¿®æ­£ã¨ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

#### **ãƒ„ãƒ¼ãƒ«ã®try-exceptåŒ…è£…**
```python
@tool
async def safe_task_lookup(query: str) -> str:
    """å®‰å…¨ãªã‚¿ã‚¹ã‚¯æ¤œç´¢ãƒ„ãƒ¼ãƒ«"""
    try:
        # å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å‡¦ç†
        results = await db.tasks.find({"description": {"$regex": query}})
        return format_results(results)
    
    except Exception as e:
        # ã‚¨ãƒ©ãƒ¼ã‚’æ§‹é€ åŒ–æƒ…å ±ã¨ã—ã¦è¿”ã™
        return f"ERROR: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¯ã‚¨ãƒªãŒå¤±æ•—ã—ã¾ã—ãŸã€‚è©³ç´°: {str(e)}\n" \
               f"å®Ÿè¡Œã—ãŸã‚¯ã‚¨ãƒª: {query}\n" \
               f"ä¿®æ­£æ¡ˆ: ã‚¯ã‚¨ãƒªã®æ§‹æ–‡ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
```

#### **è‡ªå·±ä¿®æ­£ãƒ«ãƒ¼ãƒ—ã®å®Ÿè£…**
```python
def create_error_recovery_edge(state: AgriAgentState):
    """ã‚¨ãƒ©ãƒ¼å›å¾©ã®ãŸã‚ã®æ¡ä»¶åˆ†å²"""
    last_message = state["messages"][-1]
    
    if isinstance(last_message, ToolMessage):
        if last_message.content.startswith("ERROR:"):
            return "retry_agent"  # ä¿®æ­£è©¦è¡Œã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¸
    
    return "continue"  # é€šå¸¸ãƒ•ãƒ­ãƒ¼ç¶™ç¶š

# ã‚°ãƒ©ãƒ•ã¸ã®è¿½åŠ 
workflow.add_conditional_edges(
    "data_query_agent",
    create_error_recovery_edge,
    {
        "retry_agent": "data_query_agent_retry",
        "continue": "supervisor"
    }
)
```

### 3.3 éåŒæœŸã‚¿ã‚¹ã‚¯ã¨ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£

#### **Google Cloud ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£**
```
LINE Webhook
â†“ (å³åº§ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹)
Cloud Functions (è»½é‡èªè¨¼)
â†“
Cloud Run (åŒæœŸå‡¦ç†)
â”œâ”€ é«˜é€Ÿã‚¯ã‚¨ãƒª â†’ å³åº§ã«å¿œç­”
â””â”€ é•·æ™‚é–“ã‚¿ã‚¹ã‚¯ â†’ Pub/SubæŠ•å…¥
    â†“
Cloud Run (ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ãƒ¯ãƒ¼ã‚«ãƒ¼)
â”œâ”€ LangGraphã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå®Ÿè¡Œ
â””â”€ NotificationToolçµŒç”±ã§LINEé€šçŸ¥
```

#### **éåŒæœŸå®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³**
```python
import asyncio
from google.cloud import pubsub_v1

class AsyncTaskManager:
    async def handle_request(self, message: str, user_id: str):
        # ã‚¿ã‚¹ã‚¯ã®è¤‡é›‘åº¦åˆ¤å®š
        if self._is_complex_task(message):
            # å³åº§ã«å—é ˜ç¢ºèª
            await self._send_acknowledgment(user_id)
            
            # ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã‚¿ã‚¹ã‚¯ã¨ã—ã¦æŠ•å…¥
            await self._enqueue_background_task({
                "message": message,
                "user_id": user_id,
                "task_type": "complex_planning"
            })
        else:
            # åŒæœŸçš„ã«å‡¦ç†
            return await self._process_immediately(message, user_id)
    
    async def _enqueue_background_task(self, task_data: Dict):
        publisher = pubsub_v1.PublisherClient()
        topic_path = publisher.topic_path(PROJECT_ID, TOPIC_NAME)
        
        message_bytes = json.dumps(task_data).encode("utf-8")
        future = publisher.publish(topic_path, message_bytes)
        await asyncio.wrap_future(future)
```

---

## ğŸ“Š ç¬¬4éƒ¨: ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ã¨ä¸¦è¡Œæ€§åˆ¶å¾¡

### 4.1 ãƒ¬ãƒ¼ã‚¹ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³å¯¾ç­–

#### **ã‚ªãƒ—ãƒ†ã‚£ãƒŸã‚¹ãƒ†ã‚£ãƒƒã‚¯ãƒ­ãƒƒã‚¯å®Ÿè£…**
```python
async def update_task_with_optimistic_lock(task_id: str, new_status: str):
    """æ¥½è¦³çš„ãƒ­ãƒƒã‚¯ã«ã‚ˆã‚‹å®‰å…¨ãªæ›´æ–°"""
    max_retries = 5
    
    for attempt in range(max_retries):
        # ç¾åœ¨ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å–å¾—
        task_doc = await collection.find_one({"_id": task_id})
        current_version = task_doc.get("_version", 1)
        
        # ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ¡ä»¶ä»˜ãæ›´æ–°
        result = await collection.update_one(
            {"_id": task_id, "_version": current_version},
            {
                "$set": {"status": new_status},
                "$inc": {"_version": 1}
            }
        )
        
        if result.modified_count == 1:
            return {"success": True}
        
        # ç«¶åˆç™ºç”Ÿæ™‚ã®ãƒªãƒˆãƒ©ã‚¤
        await asyncio.sleep(0.1 * (2 ** attempt))
    
    return {"error": "Update failed due to high contention"}
```

#### **è¤‡æ•°ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³**
```python
async def complete_task_and_schedule_next(task_id: str, next_task_data: dict):
    """ã‚¢ãƒˆãƒŸãƒƒã‚¯ãªã‚¿ã‚¹ã‚¯å®Œäº†ã¨æ¬¡å›ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°"""
    async with await client.start_session() as session:
        async with session.with_transaction():
            # æ“ä½œ1: ç¾åœ¨ã‚¿ã‚¹ã‚¯ã®å®Œäº†
            await work_records.update_one(
                {"_id": task_id},
                {"$set": {"status": "completed"}},
                session=session
            )
            
            # æ“ä½œ2: æ¬¡å›ã‚¿ã‚¹ã‚¯ã®ä½œæˆ
            await auto_tasks.insert_one(
                next_task_data,
                session=session
            )
```

### 4.2 è¾²æ¥­ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹å¯¾å¿œ

#### **æ³•çš„è¨˜éŒ²ä¿æŒè¦ä»¶**
```javascript
// work_records ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ v2.0 (ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹å¯¾å¿œ)
{
  "_id": ObjectId("..."),
  "_version": 1,  // ã‚ªãƒ—ãƒ†ã‚£ãƒŸã‚¹ãƒ†ã‚£ãƒƒã‚¯ãƒ­ãƒƒã‚¯ç”¨
  
  // åŸºæœ¬ä½œæ¥­æƒ…å ±
  "work_date": ISODate("2025-07-26"),
  "field_id": ObjectId("..."),
  "worker_id": ObjectId("..."),
  "work_category": "é˜²é™¤",
  
  // USDA/EPAæº–æ‹ è¨˜éŒ²
  "compliance_data": {
    "epa_registration_numbers": ["EPA-12345-6"],
    "applicator_certification_id": "CERT-789",
    "total_area_treated": 2.5,  // hectares
    "rei_hours": 12,  // Re-Entry Interval
    "phi_days": 7     // Pre-Harvest Interval
  },
  
  // ä½¿ç”¨è³‡æè©³ç´°
  "materials_used": [{
    "material_id": ObjectId("..."),
    "material_name": "ãƒ€ã‚³ãƒ‹ãƒ¼ãƒ«1000",
    "epa_reg_no": "EPA-12345-6",
    "quantity": 500.0,
    "unit": "ml",
    "dilution_ratio": "1:1000",
    "concentration": "40.0%"
  }],
  
  // æ³•çš„ç›£æŸ»ç”¨
  "audit_trail": {
    "created_by": "system",
    "created_at": ISODate("..."),
    "last_modified": ISODate("..."),
    "modification_history": []
  }
}
```

---

## ğŸ” ç¬¬5éƒ¨: è¦³æ¸¬å¯èƒ½æ€§ã¨ãƒ‡ãƒãƒƒã‚°

### 5.1 LangSmithã«ã‚ˆã‚‹å¯è¦–åŒ–

#### **ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—**
```bash
export LANGCHAIN_TRACING_V2="true"
export LANGCHAIN_API_KEY="YOUR_LANGSMITH_API_KEY"
export LANGCHAIN_PROJECT="agri-ai-agent-production"
```

#### **ãƒˆãƒ¬ãƒ¼ã‚¹åˆ†æä¾‹**
```
ãƒ¦ãƒ¼ã‚¶ãƒ¼: "ä»Šæ—¥ã®ã‚¿ã‚¹ã‚¯ã‚’æ•™ãˆã¦ã€‚ãã‚Œã¨ã€Aç•‘ã®åœŸå£Œæ°´åˆ†ã¯ï¼Ÿ"

Supervisor (1å›ç›®):
â”œâ”€ å…¥åŠ›: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
â”œâ”€ æ€è€ƒ: ã‚¿ã‚¹ã‚¯ç…§ä¼šãŒå¿…è¦ã¨åˆ¤æ–­
â””â”€ å‡ºåŠ›: Route(next="TaskManagementAgent")

TaskManagementAgent:
â”œâ”€ å…¥åŠ›: ã‚°ãƒ©ãƒ•çŠ¶æ…‹
â”œâ”€ ãƒ„ãƒ¼ãƒ«: TaskLookupToolå®Ÿè¡Œ
â””â”€ å‡ºåŠ›: ä»Šæ—¥ã®ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆ

Supervisor (2å›ç›®):
â”œâ”€ å…¥åŠ›: æ›´æ–°ã•ã‚ŒãŸçŠ¶æ…‹
â”œâ”€ æ€è€ƒ: åœŸå£Œæ°´åˆ†ã‚¯ã‚¨ãƒªãŒæœªè§£æ±º
â””â”€ å‡ºåŠ›: Route(next="FarmDataQueryAgent")

FarmDataQueryAgent:
â”œâ”€ å…¥åŠ›: ã•ã‚‰ã«æ›´æ–°ã•ã‚ŒãŸçŠ¶æ…‹
â”œâ”€ ãƒ„ãƒ¼ãƒ«: SensorDataToolå®Ÿè¡Œ
â””â”€ å‡ºåŠ›: Aç•‘ã®åœŸå£Œæ°´åˆ†ãƒ‡ãƒ¼ã‚¿

Supervisor (3å›ç›®):
â”œâ”€ å…¥åŠ›: å®Œå…¨ãªæƒ…å ±ã‚’å«ã‚€çŠ¶æ…‹
â”œâ”€ æ€è€ƒ: è¦æ±‚ãŒã™ã¹ã¦æº€ãŸã•ã‚ŒãŸ
â””â”€ å‡ºåŠ›: Route(next="FINISH")
```

### 5.2 ãƒ¡ãƒˆãƒªã‚¯ã‚¹ç›£è¦–

#### **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æŒ‡æ¨™**
```python
import time
from functools import wraps

def monitor_agent_performance(func):
    @wraps(func)
    async def wrapper(*args, **kwargs):
        start_time = time.time()
        
        try:
            result = await func(*args, **kwargs)
            
            # æˆåŠŸãƒ¡ãƒˆãƒªã‚¯ã‚¹
            execution_time = time.time() - start_time
            await log_metrics({
                "agent": func.__name__,
                "status": "success",
                "execution_time": execution_time,
                "timestamp": datetime.now()
            })
            
            return result
            
        except Exception as e:
            # ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒˆãƒªã‚¯ã‚¹
            await log_metrics({
                "agent": func.__name__,
                "status": "error",
                "error_type": type(e).__name__,
                "timestamp": datetime.now()
            })
            raise
    
    return wrapper
```

---

## ğŸš€ ç¬¬6éƒ¨: æ®µéšçš„å®Ÿè£…ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—

### Phase 1: åŸºç¤ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ (2é€±é–“)
- [ ] LangGraphåŸºæœ¬æ§‹é€ ã®æ§‹ç¯‰
- [ ] MongoDBSaverçµ±åˆ
- [ ] LineSupervisor + DataQueryAgentå®Ÿè£…
- [ ] èª­ã¿å–ã‚Šå°‚ç”¨ãƒ„ãƒ¼ãƒ«ç¾¤å®Ÿè£…
- [ ] LangSmithçµ±åˆ

### Phase 2: ã‚¤ãƒ³ãƒ†ãƒªã‚¸ã‚§ãƒ³ãƒˆæ©Ÿèƒ½ (3é€±é–“)
- [ ] AgronomyAdvisorAgentå®Ÿè£…
- [ ] PesticideRecommendationTool ã‚µãƒ–ã‚°ãƒ©ãƒ•
- [ ] TaskExecutionAgent (æ›¸ãè¾¼ã¿æ©Ÿèƒ½)
- [ ] ã‚ªãƒ—ãƒ†ã‚£ãƒŸã‚¹ãƒ†ã‚£ãƒƒã‚¯ãƒ­ãƒƒã‚¯å®Ÿè£…
- [ ] è‡ªå·±ä¿®æ­£ãƒ«ãƒ¼ãƒ—å®Ÿè£…

### Phase 3: é«˜åº¦åŒ–æ©Ÿèƒ½ (4é€±é–“)
- [ ] scratchpadã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ + åå¾©ãƒ‘ã‚¿ãƒ¼ãƒ³
- [ ] éåŒæœŸã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ (Pub/Sub)
- [ ] NotificationAgentå®Ÿè£…
- [ ] è¤‡æ•°ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³
- [ ] ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹è¨˜éŒ²å¯¾å¿œ

### Phase 4: æœ¬ç•ªæº–å‚™ (2é€±é–“)
- [ ] ç›£è¦–ãƒ»ã‚¢ãƒ©ãƒ¼ãƒˆ ã‚·ã‚¹ãƒ†ãƒ 
- [ ] ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–
- [ ] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»
- [ ] è² è·ãƒ†ã‚¹ãƒˆå®Ÿæ–½

---

## ğŸ“‹ æˆåŠŸæŒ‡æ¨™

### æŠ€è¡“æŒ‡æ¨™
- **å¿œç­”æ™‚é–“**: <3ç§’ (90%tile)
- **å¯ç”¨æ€§**: 99.9%
- **ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§**: 100%
- **ã‚¨ãƒ©ãƒ¼ç‡**: <1%

### æ¥­å‹™æŒ‡æ¨™
- **è¾²è–¬é¸å®šæ™‚é–“**: å¾“æ¥30åˆ† â†’ 0åˆ†
- **æ–°äººåˆ¤æ–­è¿·ã„æ™‚é–“**: 50%å‰Šæ¸›
- **ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹é•å**: 0ä»¶
- **ä½œæ¥­åŠ¹ç‡**: 30%å‘ä¸Š

---

## ğŸ”š ã¾ã¨ã‚

æœ¬ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã‚¬ã‚¤ãƒ‰ã¯ã€Manusã®å…ˆé€²çš„ãªè¨­è¨ˆæ€æƒ³ã‚’è¾²æ¥­ãƒ‰ãƒ¡ã‚¤ãƒ³ã«ç‰¹åŒ–ã—ã¦å¿œç”¨ã—ã€LangGraph + MongoDBã«ã‚ˆã‚‹ä¸–ç•Œã‚¯ãƒ©ã‚¹ã®ãƒãƒ«ãƒã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚·ã‚¹ãƒ†ãƒ ã‚’æ§‹ç¯‰ã™ã‚‹ãŸã‚ã®å®Œå…¨ãªãƒ–ãƒ«ãƒ¼ãƒ—ãƒªãƒ³ãƒˆã§ã™ã€‚

### æ ¸å¿ƒçš„ãªæˆåŠŸè¦å› 

1. **è²¬å‹™åˆ†å‰²**: å°‚é–€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã«ã‚ˆã‚‹ç¢ºå®Ÿæ€§å‘ä¸Š
2. **çŠ¶æ…‹ç®¡ç†**: æ°¸ç¶šåŒ–ã«ã‚ˆã‚‹å …ç‰¢æ€§ç¢ºä¿  
3. **è‡ªå·±ä¿®æ­£**: ã‚¨ãƒ©ãƒ¼ã‹ã‚‰ã®å­¦ç¿’ã¨å›å¾©
4. **ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹**: æ³•çš„è¦ä»¶ã¸ã®å®Œå…¨å¯¾å¿œ
5. **è¦³æ¸¬å¯èƒ½æ€§**: LangSmithã«ã‚ˆã‚‹å®Œå…¨ãªå¯è¦–åŒ–

ã“ã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã«ã‚ˆã‚Šã€å˜ãªã‚‹æƒ…å ±æ¤œç´¢ã‚·ã‚¹ãƒ†ãƒ ã‚’è¶…ãˆãŸã€è¾²æ¥­ç¾å ´ã®æ„æ€æ±ºå®šãƒ—ãƒ­ã‚»ã‚¹ãã®ã‚‚ã®ã‚’å¤‰é©ã™ã‚‹çœŸã®AIãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ãŒå®Ÿç¾ã•ã‚Œã¾ã™ã€‚

---

**ä½œæˆè€…**: Claude Code  
**çµ±åˆå®Œäº†**: 2025-07-26  
**æ¬¡å›æ›´æ–°**: å®Ÿè£…é€²æ—ã«å¿œã˜ã¦æ®µéšçš„æ›´æ–°