# 2025-07-27 エージェント文脈保持課題

## 概要
複数のエージェント（WorkLogRegistrationAgent だけでなく FieldAgent や SearchAgent など）において、確認質問にユーザーが回答した後、同じコンテキストで続けて処理が行われず、エージェントが「何かお手伝いできることはありますか？」と再度初期プロンプトを返す現象が発生した。

## 発生日時
- 2025-07-27 00:11（JST）

## 再現手順
1. ユーザー: 「昨日、鵡川の家裏、収穫1699ケースでした。登録しておいて」
2. エージェント: 確認メッセージを返し、登録可否を問い合わせる。
3. ユーザー: 「はい。OKです。」
4. エージェント: 「何かお手伝いできることはありますか？」と応答し、登録処理が実行されない。

## 期待される挙動
- Step3 のユーザー承諾（または続きの指示）後に、各エージェントが保持している確認データを用いて本処理（登録・検索・更新など）を完了する。
- 完了メッセージや結果データが返る。

## 実際の挙動
- 確認フロー後の承諾メッセージを受け取っても、コンテキストが失われ再度初期応答が返る。

## 想定原因
- ツール/エージェント間で `conversation_id` または確認データを保持する仕組みが欠落している。
- LINE Bot 側で Webhook イベント毎に新しいエージェントチェーンを生成している可能性。
- AgentExecutor のメモリ（ConversationBufferMemory 等）が各リクエストでリセットされている。

## TODO
- [ ] 各エージェントツール（Registration, Search, Field など）で確認データ／セッションを永続化する方法を検討（例: Redis, MongoDB, セッションファイル）。
- [ ] LINE Bot のハンドラでユーザー ID + スレッド ID 単位の状態管理を追加。
- [ ] 各エージェントの確認後処理フロー（`confirm_and_register` など）をテストコードで再現し、ユニットテストを作成。
- [ ] 上記対応後、e2e テストで連続対話の正常動作を確認。

## 関連ファイル・モジュール
- `src/agri_ai/langchain_tools/*.py`
- `src/agri_ai/agents/*.py`
- `src/agri_ai/line_bot/webhook.py`

## メモ
- 今回のケースでは、確認データ (`confirmation_data`) をどこかに一時保存し、承諾メッセージと共に再度渡すフローが必要。
- 他ツール（FieldAgent 等）でも同様の課題が起こり得るため、共通の会話状態管理レイヤを導入することを検討する。 