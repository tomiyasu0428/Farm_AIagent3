# アグリAIエージェント 開発タスクリスト

> 2025-07-26 時点。`[ ]` 未着手 / `[~]` 進行中 / `[x]` 完了

**最新状況**: システム基盤完成度78%、コアエージェント90%実装済み

---

## 🚀 Phase 1.6 – 作業記録システム高度化 🔥 **最優先**

### 作業記録品質向上とユーザーエクスペリエンス強化
- [ ] **P32 高精度情報抽出システム実装**
  - LLM Function Callingによる構造化データ出力
  - 日付、圃場名、作物名、作業分類、使用資材、使用量の正確な抽出
  - マスターデータとの自動照合・ID変換機能
  - 表記ゆれの完全吸収（「橋向こう①」→「橋向こう1」）
  
- [ ] **P33 曖昧性解決とユーザー確認フロー実装**
  - 複数候補がある場合の選択肢提示システム
  - 登録前の最終確認ダイアログ
  - 対話型データ補完機能（不足情報の質問システム）
  - バリデーション結果のリアルタイム表示
  
- [ ] **P34 作業記録の信頼性指標導入**
  - 抽出精度スコアの算出・表示
  - マスターデータ一致率の可視化
  - ユーザーフィードバックによる学習機能
  - データ品質レポートの自動生成

---

## 🎯 Phase 1.5 – AIエージェント構築ベストプラクティス実装 ⭐ **高優先**

### Manusのベストプラクティス適用
- [ ] **P25 ファイルシステム活用（外部メモリ）実装**
  - `agent_memory/todo.md`によるタスク管理システム
  - セッション情報の永続化（`agent_memory/sessions/`）
  - ファイル操作ツール群（read/write/append/list）の実装
  - AIエージェントへの「外部脳」機能提供
  
- [ ] **P26 賢いツール管理（マスキング手法）実装**
  - 全ツール事前定義システム（削除しない方式）
  - 状態マシンによるツール使用可能性制御
  - 動的なプロンプト生成（許可ツールのみ提示）
  - エージェント状態（情報収集中/データ登録中/分析中）の管理
  
- [ ] **P27 KV-Cache完全最適化**
  - 追記専用コンテキスト設計の実装
  - コンテキストウィンドウでの情報変更禁止
  - 戦略的キャッシュブレークポイント設計
  
- [ ] **P28 リサイテーション技術強化**
  - 定期的なtodo.md参照システム
  - 重要目標の復唱機能
  - 思考ループへのタスク確認組み込み
  - 自己評価と計画修正機能

---

## Phase 0 – 基盤構築 ✅ **完了**
- [x] P0 環境セットアップ（Next.js + FastAPI + MongoDB Atlas）
- [x] P12 LangChain エージェント基盤（MongoDB ツール + LLM）
- [x] P13 LINE Webhook 基盤（署名検証 & FastAPI Endpoint）
- [ ] P1 認証 & 読み取り専用ダッシュボード雛形

## Phase 1 – タスク管理 & AI 基本機能 ✅ **完了**

### ✅ 実装完了済み機能（コアシステム）
- [ ] P2 Tasks / Calendar CRUD 実装（API + MUI Calendar）
- [ ] P3 MongoDB Change Streams → LINE Push 通知
- [x] P14 TaskLookup / TaskUpdate Tool 実装
- [x] P19 FieldInfo / CropMaterial Tool 実装
- [x] P15 作業提案ロジック（農薬ローテーション & 天候）
- [x] P20 LangChainツール非同期処理問題解決
- [x] P21 LINEBOTイベントループ競合問題解決
- [x] P22 FieldAgent分離アーキテクチャ実装
- [x] P23 動的圃場名抽出システム構築
- [x] P24 LINE表示改善（ha単位、具体的実行プラン）
- [x] **P29 マルチエージェント・アーキテクチャリファクタリング**
- [x] **P30 作業記録システム実装（登録・検索）**
- [x] **P31 システム動作復旧（初期化・ツール互換性修正）**
- [x] **P32a MasterDataResolver完全実装（ID変換・表記ゆれ対応）**
- [x] **P33a 依存性注入パターン実装（MongoDB接続最適化）**
- [x] **P34a イベントループ競合問題完全解決**
- [ ] P16 150 ユーザークエリで QA テスト
- [ ] P35 リッチメッセージ対応（画像・ボタン・カルーセル）

## Phase 2 – LIFF統合とマスター管理 🎯 **中優先**

### LIFFダッシュボードとWebUI実装
- [ ] **P36 LIFF基本ダッシュボード実装**
  - 圃場マップ表示（AIによる注意喚起ハイライト）
  - 本日の作業リスト（推奨作業とタップ更新）
  - 気象情報ウィジェット（リアルタイム天気・予報）
  - 市況情報ウィジェット（栽培作物の市場価格動向）
  
- [ ] P4 圃場・作物・資材マスター CRUD UI
- [ ] P5 workers コレクション実装 & LINE ID 紐付け
- [ ] **P37 LIFFとLINEチャットのシームレス連携**
  - チャット→LIFF画面遷移の最適化
  - LIFF操作結果のチャット通知
  - オフライン対応（基本機能の一部利用可能）

## Phase 3 – 在庫管理と自動化機能 📈 **中優先**

### 高度な農業管理機能
- [ ] P6 Inventory & purchase_orders 管理モジュール
- [ ] **P38 自動スケジューリング機能**
  - 作業完了報告による次回タスク自動生成
  - 農薬ローテーション自動提案
  - 気象データ連動の作業タイミング最適化
  
- [ ] **P39 プロアクティブ提案システム**
  - 気象・作業履歴からのリスク検知
  - 能動的な情報提供機能
  - 異常パターン自動検出アラート
  
- [ ] P17 AI エージェント応答パフォーマンス最適化
- [ ] **P40 外部API統合強化**
  - 気象APIとの本格連携
  - 市況データAPI統合
  - センサーデータ取り込み基盤

## Phase 4 – 高度化とセキュリティ 🔒 **中優先**

### システム最適化と運用強化
- [ ] P7 KPI / Analytics ダッシュボード
- [ ] **P41 ユーザー適応型スキーマ進化**
  - 個別ユーザーの入力パターン学習
  - 動的データベーススキーマ拡張
  - カスタムフィールド自動生成
  
- [ ] P18 セキュリティ強化（AuthZ, RateLimiting, Logging）
- [ ] **P42 パフォーマンス最適化**
  - 応答時間3秒以内の確実な達成
  - データベースクエリ最適化
  - キャッシュ戦略の高度化

## Phase 5 – IoT統合と完全自動化 🌟 **将来対応**

### 次世代農業システム
- [ ] P8 sensor_logs 可視化 & アラート設定
- [ ] P9 notifications / schedule_rules UI & 自動タスク生成
- [ ] **P43 画像解析エージェント実装**
  - 病害虫診断システム
  - 生育状況自動判定
  - 収穫適期AI判断
  
- [ ] **P44 予測分析エージェント実装**
  - 収穫量予測モデル
  - 気象リスク予測
  - 最適作付け計画AI

## 共通タスク
- [ ] P10 ステージング環境デプロイ & UAT
- [ ] P11 ユーザーマニュアル・技術ドキュメント整備

---

## 🚀 最新の実装済み機能 (2025-07-26)

### 🤖 マルチエージェント・アーキテクチャ
- **MasterAgent**: 司令塔として専門エージェントを管理
- **FieldAgent**: 圃場情報専門エージェント
- **WorkLogRegistrationAgent**: 作業記録登録専門エージェント  
- **WorkLogSearchAgent**: 作業記録検索・分析専門エージェント
- **QueryAnalyzer**: 自然言語クエリの意図分析サービス

### 🛠️ 技術的品質向上
- **型安全性**: Protocol定義によるAny型の排除
- **依存性注入**: MongoDB接続の最適化
- **エラーハンドリング**: 包括的な例外処理
- **キャッシュ管理**: 個別タイムスタンプによる最適化

### 📱 LINE Bot機能（完全動作確認済み）
- **FieldAgentTool**: 圃場情報の取得・検索
- **WorkLogRegistrationAgentTool**: 作業記録の自然言語登録
- **WorkLogSearchAgentTool**: 作業記録の検索・分析
- **自然言語処理**: 「今日トマトハウスで収穫作業をしました」→構造化データ変換

### 🗃️ データベース設計
- **work_logsコレクション**: 構造化された作業記録保存
- **複合インデックス**: 高速検索のための最適化設計
- **ID正規化**: マスターデータとの整合性確保
- **MasterDataResolver**: 文字列表記ゆれの解決

### 🔧 解決済み技術課題
- **システム初期化**: MasterAgent.__init__での自動初期化
- **ツール互換性**: AgriAIBaseToolとの完全互換性
- **非同期処理**: イベントループ競合問題の完全解決
- **MongoDB接続**: 依存性注入による接続最適化
- **ID正規化システム**: 表記ゆれの完全対応
- **ファイル管理**: 日付付きドキュメント構造の統一
- **型安全性**: Protocol定義による堅牢性向上

---

## 📊 開発優先順位と期間見積もり

### 🔥 最優先（Phase 1.6）- 2週間
1. **P32 高精度情報抽出システム** (5日)
   - Function Calling構造化出力
   - マスターデータ自動照合
   - 表記ゆれ完全対応

2. **P33 曖昧性解決フロー** (5日)
   - 対話型データ補完
   - 登録前確認システム
   - バリデーション可視化

3. **P34 作業記録信頼性指標** (4日)
   - 精度スコア算出
   - 品質レポート生成
   - 学習機能実装
   
### ⭐ 高優先（Phase 1.5）- 2週間  
4. **P25 ファイルシステム活用** (4日)
5. **P26 賢いツール管理** (4日)
6. **P27-28 KV-Cache & リサイテーション** (6日)

### 🎯 中優先（Phase 2）- 4週間
7. **P36 LIFF基本ダッシュボード** (2週間)
8. **P4 マスター管理UI** (1.5週間)
9. **P5 ワーカー管理** (0.5週間)

### 📈 中優先（Phase 3-4）- 5週間
10. **P38-39 自動化機能** (2週間)
11. **P6 在庫・発注管理** (1.5週間)
12. **P7 分析ダッシュボード** (1.5週間)

---

## 🎉 技術的達成状況サマリー

### ✅ 完全実装（完成度90%以上）
- **マルチエージェント・アーキテクチャ**: 4つの専門エージェント完成
- **作業記録システム基盤**: 登録・検索・分析機能実装済み
- **データベース統合**: MongoDB完全統合、13コレクション対応
- **LINE Bot統合**: Webhook、メッセージ処理完成
- **マスターデータ連携**: ID変換・表記ゆれ対応完成

### 🔄 部分実装（完成度80-90%）
- **作業記録高度化**: 基本機能 ✅ / 高精度抽出・確認フロー ❌
- **LIFF統合**: 基盤 ✅ / ダッシュボード・ウィジェット ❌
- **リッチメッセージ**: 基本テキスト ✅ / 画像・ボタン対応 ❌
- **自動化機能**: 基本提案 ✅ / プロアクティブ・スケジューリング ❌

### ❌ 未実装（Phase 1.6で対応）
- **高精度情報抽出**: Function Calling活用の構造化出力
- **曖昧性解決フロー**: 対話型データ補完・確認システム
- **LIFF高機能化**: ダッシュボード・ウィジェット・マップ表示
- **自動化システム**: プロアクティブ提案・自動スケジューリング

**目標**: Phase 1.6完了により、実用レベルの高品質農業AIエージェントシステムを実現

---

**最終更新**: 2025年7月26日  
**システム状態**: 完全動作 ✅（基盤完成度78%）  
**次期開発**: Phase 1.6 作業記録システム高度化 → `docs/plans/2025-07-26_作業記録高度化計画.md`参照  
**技術負債**: 解決済み（イベントループ、型安全性、接続管理）