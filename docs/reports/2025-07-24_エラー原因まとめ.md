# 2025-07-24 エラー原因まとめ

## 1. MongoDB 接続関連
- **症状**: `TopologyDescription ... ReplicaSetNoPrimary` が頻発。
- **原因**: `.env` の `MONGODB_CONNECTION_STRING` が ReplicaSet 用。ネットワーク遅延で primary が捕捉出来ずタイムアウト。
- **対応**:
  1. `serverSelectionTimeoutMS` を 5 → 15 秒に延長。
  2. VPN/Firewall を確認。

## 2. `Optional` 未定義
- **症状**: `name 'Optional' is not defined`。
- **原因**: `typing` からの import 漏れ。
- **対応**: `from typing import Optional` を追加。

## 3. 循環インポート (`WorkLogSearchAgent` ↔ `Tool`)
- **症状**: `partially initialized module` エラー。
- **原因**: 相互 import。
- **対応**: ツール側を遅延インポート (`_get_agent()` 内) に変更。

## 4. Pydantic Validation Error
- **症状**: `1 validation error for WorkLogRegistrationAgentTool agent Field required`。
- **原因**: `agent` を Pydantic フィールド扱いにしてしまった。
- **対応**: プライベート属性 `_work_log_registration_agent` に変更し `Field(exclude=True)` を削除。

## 5. `object has no field`
- **症状**: ツールに動的に追加した属性が Pydantic に認識されず。
- **原因**: Public 属性は自動でモデル化される。
- **対応**: すべて `_xxx` 形式へ変更。

## 6. `find_fields_by_name` 不足
- **症状**: `DataAccess` にメソッドが無い。
- **原因**: 旧版互換 API が削除されていた。
- **対応**: `DataAccessLayer` に実装を追加。

## 7. `coroutine' object has no attribute 'find'`
- **症状**: `get_collection` を `await` せずコルーチンを渡した。
- **原因**: `_get_collection` が `async` で `await` し忘れ。
- **対応**: `await self._get_collection()` として修正。

## 8. `AgriAIBaseTool._run() missing 1 required positional argument: 'query'`
- **症状**: ツール呼び出しで `query` 無し。
- **原因**: `work_log_registration_agent_tool` は `message`/`user_id` を取るのに、LangChain が `query` パラメータを要求。
- **対応**:
  1. ツールの `__call__` 互換のため `query: str = ""` をダミー追加。
  2. LangChain 側 schema をオーバーライド。

## 未解決・要確認
- `coroutine was never awaited` 警告 → `_get_collection` ラップ箇所を全体的に確認。
- データ整合性: `fields` コレクションに `name: 学校裏①` が存在するか。

---
以上。 