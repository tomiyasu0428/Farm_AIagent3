# 農業管理AIエージェント ─ MongoDB 総合設計書

**バージョン**: 1.0
**作成日**: 2025-07-26
**最終更新者**: Gemini

---

## 1. 目的
本ドキュメントは、農業管理AIエージェントシステムにおけるデータベースの統一的な設計を定義します。Airtableからの移行、および将来的な拡張性を見据え、LangChain + LINEエージェントが高速かつ柔軟にデータを参照・更新できる基盤を構築することを目的とします。

---

## 2. 設計思想
- **ドキュメント指向設計**: 圃場や作業記録といった中心的なエンティティごとに関連情報を集約したドキュメント構造を採用し、JOIN操作を最小化します。
- **埋め込み優先**: 1対多の関係性において、関連データが少量かつ同時にアクセスされる場合は、サブドキュメントとして埋め込み、クエリの効率を高めます。
- **柔軟なスキーマと動的拡張**: 固定スキーマに縛られず、ユーザーの入力パターンや新しい要件に応じてAIがフィールドを自動で提案・拡張できる「成長するデータ構造」を目指します。
- **時系列データ対応**: 作業履歴やセンサーデータなど、時系列で発生するデータを効率的に格納し、期間での集計や分析が容易な設計とします。
- **ID正規化**: 外部参照は、マスターデータ（`crops`, `materials`など）の`_id`によって正規化し、データの一貫性を保ちます。

---

## 3. コレクション一覧
| コレクション | 役割 | 主キー | 参照関係 | 備考 |
|--------------|------|--------|----------|------|
| `users` | ユーザーマスター | `_id(ObjectId)` | - | LINEアカウント紐付け、個別設定 |
| `fields` | 圃場マスター | `_id(ObjectId)` | `current_cultivation.crop_id` | 現在作付け・次回作業を保持 |
| `crops` | 作物マスター | `_id(ObjectId)` | `applicable_materials.material_id` | 栽培カレンダー/病害虫リスク含む |
| `materials` | 資材マスター | `_id(ObjectId)` | – | 農薬/肥料共通 |
| `work_logs` | 作業履歴 | `_id(ObjectId)` | `user_id`, `field_id`, `material_ids` | 自然言語からの構造化データ |
| `cultivation_plans` | 作付け計画 | `_id(ObjectId)` | `field_id`, `crop_id` | 1圃場×1年ドキュメント |
| `scheduled_tasks` | 予定タスク(未実施) | `_id(ObjectId)` | `field_id` | 日次バッチ/LINE 通知用 |
| `sensor_logs` | センサーデータ | `_id(ObjectId)` | `field_id` | 圃場環境ログ |
| `inventory` | 資材在庫 | `_id(ObjectId)` | `material_id` | しきい値監視 |
| `purchase_orders` | 資材発注 | `_id(ObjectId)` | `material_id` | 発注・受領管理 |
| `notifications` | 通知設定 | `_id(ObjectId)` | `user_id` | LINE/メール等 |
| `schedule_rules` | 自動スケジュール規則 | `_id(ObjectId)` | `user_id` | 作業生成ルール |

---

## 4. 主要ドキュメント定義

### 4.1 `work_logs` (作業履歴)
自然言語の作業報告を構造化して保存するコアコレクション。

```jsonc
{
  // 基本識別情報
  "_id": ObjectId,
  "log_id": "LOG-20250724-A1B2C3D4",  // 人間可読な記録ID
  "user_id": ObjectId,              // `users`コレクションへの参照
  
  // 時間情報
  "work_date": ISODate,               // 実際の作業実施日 (重要: created_atと分離)
  "created_at": ISODate,              // 記録作成日時
  "updated_at": ISODate,              // 記録更新日時
  
  // 原文情報
  "original_message": "昨日トマトハウスで防除作業をしました", // ユーザーの元メッセージ
  
  // 構造化された抽出データ
  "extracted_data": {
    "field_id": ObjectId,          // `fields`コレクションへの参照
    "field_name": "トマトハウス",       // 正規化済み圃場名
    "crop_id": ObjectId,            // `crops`コレクションへの参照
    "crop_name": "トマト",             // 正規化済み作物名
    "variety": "桃太郎",               // 品種（オプショナル）
    "material_ids": [ObjectId],     // `materials`コレクションへの参照配列
    "material_names": ["ダコニール1000"], // 正規化済み資材名の配列
    "work_details": {
      "dilution_ratio": "1000倍",     // 希釈倍率
      "application_amount": "100L",   // 使用量
      "work_duration": 120,           // 作業時間(分)
    },
    "quality_info": {
      "crop_condition": "健全",       // 作物状態
      "weather_condition": "曇り",    // 天候
      "notes": "病斑は見られず"       // 補足メモ
    }
  },
  
  // ユーザー適応型拡張フィールド
  "user_specific_data": {},

  // 分類・タグ情報
  "category": "防除",                 // 作業分類 (防除/施肥/栽培/収穫/管理/その他)
  "tags": ["防除", "殺菌剤", "予防"],  // 検索用タグ配列
  
  // メタデータ
  "confidence": 0.85,                 // 情報抽出の信頼度 (0.0-1.0)
  "status": "confirmed",              // 記録状態 (draft/confirmed/reviewed)
  "source": "line_bot",               // データソース (line_bot/web_ui/api)
  "version": 1.1,                     // スキーマバージョン
  "_v": 1                             // オプティミスティックロック用バージョン
}
```

### 4.2 `fields` (圃場マスター)
```jsonc
{
  "_id": ObjectId,
  "field_code": "F01",
  "name": "橋向こう①",
  "area": 1.2, // ha単位
  "location": { "lat": 35.12, "lon": 139.56 },
  "soil_type": "砂壌土",
  "current_cultivation": {
    "crop_id": ObjectId, // `crops`コレクションへの参照
    "variety": "桃太郎",
    "planting_date": "2024-03-15",
    "growth_stage": "開花期"
  },
  "next_scheduled_work": {
    "work_type": "防除",
    "scheduled_date": "2024-07-17",
    "materials": [ObjectId] // `materials`コレクションへの参照
  },
  "_v": 1 // オプティミスティックロック用バージョン
}
```

### 4.3 `crops` (作物マスター)
```jsonc
{
  "_id": ObjectId,
  "name": "トマト",
  "variety": "桃太郎",
  "category": "果菜類",
  "cultivation_calendar": [
    { "stage": "育苗期", "days_from_planting": [0,30], "key_activities": ["灌水","温度管理"] }
  ],
  "disease_pest_risks": [
    { "name": "疫病", "risk_period": ["5月","6月"], "prevention_materials": ["銅水和剤"] }
  ],
  "applicable_materials": [
    { "material_id": ObjectId, "application_timing": "生育期", "dilution_rate": "1000倍" }
  ]
}
```

### 4.4 `materials` (資材マスター)
```jsonc
{
  "_id": ObjectId,
  "name": "ダコニール1000",
  "type": "殺菌剤",
  "active_ingredient": "TPN",
  "dilution_rates": { "tomato": "1000倍" },
  "preharvest_interval": 7,
  "max_applications_per_season": 5,
  "rotation_group": "M",
  "target_diseases": ["疫病"],
  "usage_restrictions": { "bee_toxicity": "注意" }
}
```

### 4.5 `users` (ユーザーマスター)
```jsonc
{
  "_id": ObjectId,
  "name": "佐藤花子",
  "role": "worker",        // admin / manager / worker
  "line_user_id": "Uxxxxxxxx",
  "is_active": true,
  "profile": {
      "farm_type": "vegetable",
      "experience_level": "intermediate",
      "custom_fields": {}, // 動的拡張用
      "terminology": {} // ユーザー固有の用語辞書
  },
  "created_at": ISODate("2025-07-16T00:00:00Z")
}
```

---

## 5. インデックス設計
| コレクション | フィールド | 目的 |
|--------------|-----------|------|
| `work_logs` | `user_id`, `work_date`, `category` (compound) | ユーザー・日付・分類での主要検索 |
| `work_logs` | `user_id`, `extracted_data.field_id`, `work_date` | 圃場別履歴検索 |
| `work_logs` | `user_id`, `extracted_data.material_ids` | 資材使用履歴検索 |
| `work_logs` | `original_message`, `extracted_data.field_name` (text) | 全文検索 |
| `fields` | `field_code` (unique) | 圃場コードでの直接検索 |
| `fields` | `name` | 圃場名での検索 |
| `materials` | `name` (text) | 資材名検索 |
| `crops` | `name`, `category` | 作物検索 |
| `users` | `line_user_id` (unique) | LINEアカウント連携 |
| `sensor_logs` | `field_id`, `logged_at` | 圃場×時系列センサー検索 |
| `inventory` | `material_id` | 在庫照会 |

---

## 6. 自動スキーマ拡張とパーソナライゼーション

### 6.1. コンセプト
ユーザーの入力パターンや専門用語をAIが学習し、`users.profile.custom_fields` や `work_logs.user_specific_data` を動的に拡張する。これにより、画一的なシステムではなく、各ユーザーに最適化された「成長するデータベース」を実現する。

### 6.2. 拡張フロー
1.  **パターン分析**: AIエージェントが定期的にユーザーの `work_logs` を分析し、頻出する作業内容や専門用語のパターンを検出する。
2.  **拡張提案**: 特定のパターン（例: 防除記録が多い、特定の専門用語を多用）を検出した場合、LINEを通じて新しい専用フィールドの追加や、用語辞書への登録を提案する。
3.  **ユーザー承認**: ユーザーがLINEのボタンで承認すると、スキーマ拡張が実行される。
4.  **スキーマ拡張**:
    *   `users.profile` に拡張フラグを立てる。
    *   `work_logs` に `user_specific_data` として新しいフィールド構造を追加する。
    *   （オプション）過去の関連ログを再解析し、新しい構造にデータを埋め込む。

### 6.3. 拡張例（小麦農家）
- **ユーザープロファイル**: `users.profile.terminology` に `{"クプロシールド": "fungicide"}` を自動登録。
- **作業ログ**: `work_logs.user_specific_data` に以下のフィールドを自動生成。
  ```jsonc
  "user_specific_data": {
    "crop_specific": { "crop": "小麦", "growth_stage": "ログ期" },
    "pest_control": { "pesticides_used": [{ "name": "クプロシールド", "type": "fungicide" }] }
  }
  ```

---

## 7. ゼロスタート運用時の留意点
1.  **参照整合性の担保**: `crop_id` や `material_id` などの参照は、UIのプルダウンやオートコンプリートで選択させる。
2.  **必須・任意フィールドの明確化**:
    *   **必須**: `fields.name`, `work_logs.work_date`, `work_logs.category`
    *   **任意**: `fields.soil_type`, `work_logs.extracted_data.materials_used`
3.  **初期データ投入シーケンス**:
    1.  最小限の作物・資材マスターを登録
    2.  圃場 (`fields`) を登録
    3.  日々の作業 (`work_logs`) を随時追加

---
