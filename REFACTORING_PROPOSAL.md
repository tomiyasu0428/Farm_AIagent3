
# Agri-AI プロジェクト リファクタリング提案書

現在のコードベースを分析し、将来的な保守性、テスト容易性、拡張性を向上させるためのリファクタリング案を以下に提案します。

## 1. 設定管理 (`core/config.py`)

- **課題:**
    - `pydantic-settings` を利用しているが、環境変数ファイル `.env` が存在しない場合にエラーになる可能性がある。
    - 設定項目が増えると、クラスが肥大化する可能性がある。
- **提案:**
    - `.env` ファイルの存在チェックと、存在しない場合のエラーメッセージをより分かりやすくする。
    - 関連する設定（例: `LINE_*`, `MONGO_*`）をそれぞれ別のクラスに分割し、メインの `Settings` クラスでそれらを読み込むようにする。これにより、関心事が分離され、管理しやすくなる。

## 2. データベースクライアント (`database/mongodb_client.py`)

- **課題:**
    - `MongoDBClient` がグローバルインスタンスとして作成されており、単体テストがしにくい。
    - 接続・切断ロジックが `connect`, `disconnect` メソッドに分散している。
- **提案:**
    - **依存性注入 (Dependency Injection) の導入:** `MongoDBClient` のインスタンスをグローバルに作成するのではなく、FastAPIの依存性注入システムなどを利用して、必要な箇所（リポジトリ層やツールなど）に渡すようにする。これにより、テスト時にモックのDBクライアントを注入できるようになる。
    - **コンテキストマネージャの利用:** `async with` 構文を使えるように、`__aenter__` と `__aexit__` を実装し、接続と切断を自動化する。

## 3. LangChain ツール (`langchain_tools/`)

- **課題:**
    - `_parse_query` のロジックがツール内にハードコードされており、柔軟性に欠ける（例: `TaskLookupTool` の日付解析、`FieldInfoTool` の圃場名解析）。
    - 各ツールで `_get_collection` を呼び出しており、冗長。
    - 結果のフォーマットロジック (`_format_result`) が各ツールに散らばっており、一貫性がない。
- **提案:**
    - **クエリ解析の汎用化:** 自然言語処理（NLU）のライブラリ（例: `dateparser`）を導入し、"今日", "明日", "来週" といった曖昧な表現を正確な日時に変換するユーティリティ関数を作成する。
    - **ベースクラスの強化:** `AgriAIBaseTool` に、よく使われるコレクション（`fields`, `tasks` など）をプロパティとして持たせる。
    - **フォーマット処理の統一:** 結果を整形するための専用のフォーマッタクラスを作成し、ツールからはそのクラスを利用するようにする。これにより、LINEのメッセージ形式（テキスト、カード、カルーセルなど）に合わせた出力を柔軟に切り替えられるようになる。

## 4. LINE Webhook (`line_bot/webhook.py`)

- **課題:**
    - 署名検証ロジック `_verify_signature` が `webhook.py` 内に直接実装されている。
    - `handle_text_message` 内で、メッセージ処理と応答送信のロジックが密結合している。
- **提案:**
    - **署名検証のミドルウェア化:** FastAPIのミドルウェアとして署名検証を切り出すことで、エンドポイントのロジックをクリーンに保つ。
    - **ロジックの分離:** `handle_text_message` からAIエージェントの呼び出し部分をサービスクラス（例: `LineBotService`）に分離する。Webhookのエンドポイントは、リクエストの検証とサービスの呼び出しに専念させる。

## 5. モデル定義 (`database/models.py`)

- **課題:**
    - `PyObjectId` のようなカスタムクラスが必要になっている。
    - ドキュメント間のリレーションシップが `PyObjectId` で表現されているが、実際のデータ取得時には追加のクエリが必要になる。
- **提案:**
    - **ODM (Object-Document Mapper) の導入:** `Beanie` や `Motor-ODM` のような非同期対応のODMを導入する。これにより、`PyObjectId` のようなボイラープレートコードが不要になり、PythonのクラスとしてDBのドキュメントを直感的に操作できるようになる。
    - **リレーションの明確化:** ODMの機能を使って、ドキュメント間のリレーション（例: `Link`, `BackLink`）をモデル定義の時点で明示的にする。これにより、関連ドキュメントの取得が容易になる。

## 6. 全体的な構造

- **課題:**
    - `core`, `database`, `langchain_tools`, `line_bot` という分割はされているが、それぞれの責務がさらに大きくなると見通しが悪くなる可能性がある。
- **提案:**
    - **リポジトリパターンの導入:** データベース操作を抽象化するためのリポジトリ層を `database` モジュール内に追加する。例えば、`FieldRepository` を作成し、圃場データのCRUD操作をそこにまとめる。ツールやエージェントは、`mongodb_client` を直接触るのではなく、このリポジトリを介してデータにアクセスする。
    - **ドメイン駆動設計 (DDD) の要素を取り入れる:** `domain` パッケージを新たに作成し、アプリケーションの中核となるビジネスロジック（作物、圃場、タスクなど）をエンティティやバリューオブジェクトとして定義する。現在の `models.py` は、永続化のためのデータ構造に特化させ、ドメインオブジェクトとマッピングする形にする。
