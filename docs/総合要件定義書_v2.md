# 農業管理AIエージェント 総合要件定義書 v2.0

**バージョン**: 2.0
**作成日**: 2025-07-26
**最終更新者**: Gemini

---

## 第1部: プロジェクトビジョンと戦略 (Why)

### 1.1. 核心コンセプト：共に成長するデジタルパートナー
本プロジェクトは、LINEプラットフォーム上で動作するAIエージェントおよびLIFFアプリケーションを通じ、農業従事者に**「パーソナライズされ、共に進化するデジタルパートナー」**を提供することを目的とする。

自然言語インターフェース、柔軟なデータ構造、そしてAIの学習能力を組み合わせることで、思考のプロセスそのものをなくし、誰もが熟練者のように自信を持って日々の作業に取り組める未来を実現する。

### 1.2. 解決したい課題
- **情報の散在**: 天気、市況、作業履歴などの情報が別々のツールに散在し、統合的な判断が難しい。
- **経験と勘への依存**: 新規就農者や経験の浅い作業者にとって、適切なタイミングでの判断が困難。特に「どの畑の」「どの作物に」「いつ、どの農薬を散布すべきか」といった判断は大きな負担となっている。
- **労働力不足と多忙**: 日々の作業記録や計画立案に多くの時間が割かれている。
- **多様化するニーズ**: 農業スタイルや導入技術に応じて、管理したいデータ項目がユーザーごとに異なる。

### 1.3. 開発のゴールと成功指標
- **定性ゴール**: 作業員が、圃場のどこにいても、スマホ一つで「次に何をすべきか」の具体的な指示を受け取り、思考の負荷なく、自信を持って作業に集中できるようになる。
- **定量ゴール (KPI)**:
    - 農薬選定にかかる時間が平均10分から0分になる。
    - 新人作業員が判断に迷う時間が週平均60分から5分未満に短縮される。
    - LINE経由でのタスク実行率が95%以上を維持する。
    - AIの応答時間を3秒以内に短縮する。

---

## 第2部: システム設計とアーキテクチャ (How)

### 2.1. 全体アーキテクチャ：Supervisor-Workerパターン
本システムは、単一のモノリシックなエージェントではなく、**LangGraph**フレームワークを利用した**「スーパーバイザー・ワーカー（Supervisor-Worker）」マルチエージェント・アーキテクチャ**を採用する。これにより、システムの信頼性、保守性、拡張性を飛躍的に向上させる。

- **LineSupervisor (司令塔)**: ユーザーの意図を分析し、最適な専門エージェント（ワーカー）にタスクを振り分ける。
- **専門エージェント (ワーカー)**: 特定の責務に特化したエージェント群。
    - **TaskManagementAgent**: タスクの作成、更新、照会を担う。
    - **AgronomyAdvisorAgent**: 農薬、肥料、天候、在庫に基づく専門的な助言を提供する。
    - **FarmDataQueryAgent**: 圃場、センサー、作業履歴に関するデータ照会に応答する。
    - **NotificationAgent**: ユーザーへの通知やアラートを管理する。

```mermaid
graph TD
    subgraph ユーザー
        A[👤 農業従事者]
    end

    subgraph LINEプラットフォーム
        B[📱 LIFF / トークルーム]
    end

    subgraph AI層 (LangGraph)
        C[🧠 LineSupervisor]
        subgraph ワーカーエージェント
            W1[🛠️ TaskMgmtAgent]
            W2[🛠️ AgronomyAdvisorAgent]
            W3[🛠️ FarmDataQueryAgent]
            W4[🛠️ NotificationAgent]
        end
    end

    subgraph バックエンド層
        E[⚙️ ワークフローエンジン]
        F[☁️ 外部API]
        G[🗄️ MongoDBデータベース]
    end

    A -- 対話・操作 --> B
    B -- リクエスト --> C
    C -- タスク割当 --> W1 & W2 & W3 & W4
    W1 & W2 & W3 & W4 -- ツール実行 --> E & F & G
    E & F & G -- 結果 --> W1 & W2 & W3 & W4
    W1 & W2 & W3 & W4 -- 報告 --> C
    C -- 応答生成 --> B
    B -- 結果表示 --> A
```

### 2.2. UI/UX設計：LINEとLIFFのシームレスな連携
- **LINEチャット**: 「今日の消毒作業終わりました」といった簡単な報告や、「A畑の次の作業は？」といった簡単な質問に使用。
- **LIFF (LINE Front-end Framework)**: よりリッチなUIを提供し、ブラウザ級の分析・可視化機能をLINE内で完結させる。
    - **基本ダッシュボード機能**:
        - **圃場マップ表示**: AIによる注意喚起がある圃場をハイライト表示。
        - **本日の作業リスト**: AIが計画した推奨作業リストを表示し、進捗をタップで更新可能。
        - **気象情報ウィジェット**: 現在地のリアルタイム気象情報と予報を表示。
        - **市況情報ウィジェット**: 栽培中の作物に関連する市場価格の動向を表示。

### 2.3. データベース設計
データベースのスキーマ、インデックス設計、運用方針に関する詳細は、以下の統一設計書に集約する。
- **参照先**: `docs/design/MongoDB_総合設計書.md`

### 2.4. 機能要件 (抜粋)
- **[F-01] マルチエージェントによるタスク処理**: LineSupervisorがユーザーの意図を解釈し、適切な専門エージェントに処理を委譲する。
- **[F-02] データ管理**: 各専門エージェントは、担当するMongoDBコレクションのデータを参照・作成・更新できる。
- **[F-03] 自動スケジューリング**: 作業完了報告時に、次回の関連タスク（例: 7日後の防除）を自動でスケジュールする。
- **[F-04] プロアクティブ提案**: ユーザーが問い合わせる前に、AIが気象データや作業履歴からリスクや機会を検知し、能動的に情報を提供する。
- **[F-05] LIFFダッシュボード**: LIFFを用いて、圃場マップ、タスクリスト、各種ウィジェットなどを表示する。
- **[F-06] ユーザー適応型スキーマ進化**: ユーザーの入力パターンを学習し、データベーススキーマを個別最適化する機能を将来的に導入する。

### 2.5. 非機能要件
- **パフォーマンス**: ユーザーからの問い合わせに対し、3秒以内に応答を返す。
- **ユーザビリティ**: ITに不慣れなユーザーでも直感的に操作できるシンプルなUI。音声入力にも対応。
- **セキュリティ**: APIキーや接続情報はGoogle Secret Manager等で安全に管理する。
- **データ整合性**: オプティミスティックロックやトランザクションを利用し、複数ユーザーの同時操作でもデータの整合性を保証する。
- **オフライン対応**: 通信環境が不安定な圃場でも、基本的な作業記録や確認ができるよう、一部機能をオフラインで利用可能にする。

---

## 第3部: 開発ロードマップと技術スタック (What)

### 3.1. 開発フェーズ戦略
| フェーズ | 期間 | 主要目標 |
|---|---|---|
| **Phase 1: 基盤構築** | 4週間 | 動作するマルチエージェントシステムの構築と、基本的な記録・参照機能の実装。 |
| **Phase 2: AI機能実装** | 4週間 | 作業提案システム、基本的なスケジューリング、LIFF基本ダッシュボードの実装。 |
| **Phase 3: 高度化** | 4週間 | LIFF高機能化、気象API等の外部連携、基本センサー連携。 |
| **Phase 4: 最適化** | 4週間 | ユーザー学習に基づく個別最適化、動的スキーマ拡張、パフォーマンスチューニング。 |

### 3.2. 技術スタック
- **言語**: Python 3.9+
- **AIエージェント**: LangChain, LangGraph
- **LLM**: Google Gemini Pro / Flash
- **データベース**: MongoDB Atlas (Motorによる非同期アクセス)
- **インフラ**: Google Cloud Functions (Webhook), Google Cloud Run (エージェント実行環境)
- **UI**: LINE Messaging API, LIFF
- **ソースコード管理**: Git / GitHub
- **監視**: LangSmith

### 3.3. 主要な成果物
- LangGraphで構築されたマルチエージェントシステムのソースコード。
- 各専門エージェントおよびLangChainツールのソースコード。
- Google Cloud Functions上で動作するLINE Webhook用関数。
- `MongoDB_総合設計書.md`
- `総合要件定義書_v2.md` (このドキュメント)
