# 2025-07-26 作業記録システムの高度化計画

## 1. 目的
現在の作業記録登録機能を強化し、ユーザーからの自然言語メッセージを、単なるテキストではなく**マスターデータと紐付いた信頼性の高い構造化データ**としてデータベースに保存する。これにより、データ品質を飛躍的に向上させ、将来的なデータ分析、作業提案、異常検知などの高度な機能の基盤を構築する。

## 2. 実装計画

### Step 1: `WorkLogRegistrationAgent`の機能強化（高精度な情報抽出）
LLMの構造化データ出力機能（Function Calling/Tool Calling）を活用し、ユーザーの自由なテキスト入力から、より詳細で正確な情報を抽出するロジックを実装する。

- **入力例:** `「昨日、橋向こう①でトマトにダコニール1000を500L散布した」`

- **抽出ターゲット:**
  - **日付**: `work_date` (「昨日」→ `2025-07-25`)
  - **圃場名**: `field_name` ("橋向こう①")
  - **作物名**: `crop_name` ("トマト")
  - **作業分類**: `category` ("散布" → "防除")
  - **使用資材**: `materials` (["ダコニール1000"])
  - **使用量**: `quantity` (500)
  - **単位**: `unit` ("L")

### Step 2: マスターデータとの照合・検証 (Validation)
抽出した文字列情報を、データベースのマスターコレクション（`fields`, `crops`, `materials`）と照合し、対応するドキュメントの `_id` と紐付ける。

- **圃場名の検証**: 抽出した `"橋向こう①"` を `fields` コレクションで検索し、正規化された圃場名と `field_id` を取得する。これにより、表記の揺れ（例: 「橋向こう1」）も吸収する。
- **資材名の検証**: 抽出した `"ダコニール1000"` を `materials` コレクションで検索し、`material_id` を取得する。

### Step 3: 曖昧性解決とユーザー確認フローの導入
データベースへの保存前に、情報の曖昧性を解消し、ユーザーの承認を得るプロセスを導入する。

- **曖昧性の解決**: マスターデータとの照合で候補が複数存在する場合や、一致しない場合に、AIがユーザーに質問を投げかける。
  - **例**: `「「ダコニール」という資材が見つかりましたが、「ダコニール1000」と「ダコニールZ」のどちらですか？」`

- **登録前の最終確認**: 全ての情報が確定した後、構造化されたデータをユーザーに提示し、登録の最終確認を求める。
  - **例**: `「以下の内容で記録しますか？
    - 日付: 2025-07-25
    - 圃場: 橋向こう①
    - 作業: 防除 (トマト)
    - 資材: ダコニール1000 (500L)
    [はい] [いいえ]」`

## 3. 期待される効果
- **データ品質の向上**: 全ての作業記録がマスターデータと関連付けられ、正規化されたデータとして蓄積される。
- **分析・提案精度の向上**: 正確なデータに基づくことで、将来の収穫予測、コスト分析、農薬ローテーション提案などの精度が向上する。
- **ユーザーエクスペリエンスの向上**: AIとの対話を通じて、正確な作業記録を簡単かつ確実に残せるようになる。

## 4. 関連ドキュメント
- `docs/総合要件定義書_v2.md`
- `docs/design/MongoDB_総合設計書.md`
