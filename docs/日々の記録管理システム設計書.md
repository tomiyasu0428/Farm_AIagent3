概要

  LINEでの自由な作業報告を受け取り、構造化してデータベースに保存。後から検索・呼び出し可能
  なシステムを設計します。

  1. データベース設計

  1.1 作業記録テーブル（work_logs）

  {
    "_id": ObjectId,
    "log_id": "LOG-20250724-001",  // 自動採番
    "user_id": "user123",
    "date": ISODate("2025-07-24"),
    "original_message": "トマト桃太郎の防除3回目、ダコニール1000使用",

    // AI抽出情報
    "extracted_data": {
      "crop_name": "トマト",
      "variety": "桃太郎",
      "work_type": "防除",
      "work_count": 3,
      "materials": ["ダコニール1000"],
      "field_name": "第1ハウス",
      "confidence": 0.85
    },

    // 分類情報
    "category": "pest_control",  // pest_control, fertilization, cultivation, harvest, etc.
    "tags": ["防除", "殺菌剤", "トマト"],

    // メタデータ
    "created_at": ISODate("2025-07-24T10:30:00Z"),
    "updated_at": ISODate("2025-07-24T10:30:00Z"),
    "status": "confirmed"  // pending, confirmed, corrected
  }

  1.2 作業分類マスター（work_categories）

  {
    "_id": ObjectId,
    "category_id": "pest_control",
    "category_name": "防除作業",
    "keywords": ["防除", "農薬", "殺菌", "殺虫", "散布"],
    "required_fields": ["crop_name", "materials"],
    "optional_fields": ["work_count", "dilution_rate", "weather"]
  }

  2. AIエージェント設計

  2.1 WorkLogAgent（作業記録専門エージェント）

  役割: 自然言語の作業報告を構造化データに変換・保存

  主要機能:
  - 自然言語解析による情報抽出
  - 作業分類の自動判定
  - データベースへの保存
  - 曖昧な情報の確認・補完

  2.2 WorkLogSearchAgent（記録検索専門エージェント）

  役割: 保存された作業記録の検索・集計

  主要機能:
  - 日付・作物・作業種別での検索
  - 防除履歴の回数集計
  - 期間別作業サマリー
  - 材料使用履歴の追跡

  3. ツール設計

  3.1 WorkLogRegistrationTool

  class WorkLogRegistrationTool(BaseTool):
      name = "work_log_registration"
      description = """
      自然言語の作業報告をデータベースに登録
      入力例: 「トマト桃太郎の防除3回目、ダコニール1000使用」
      """

      async def _run(self, message: str, user_id: str) -> dict:
          # 1. 自然言語解析
          extracted = await self._extract_work_info(message)

          # 2. 作業分類判定
          category = await self._classify_work_type(extracted)

          # 3. データ検証・補完
          validated = await self._validate_and_complete(extracted)

          # 4. データベース保存
          log_id = await self._save_to_database(validated, user_id, message)

          return {
              "success": True,
              "log_id": log_id,
              "extracted_data": validated,
              "message": "作業記録を保存しました"
          }

  3.2 WorkLogSearchTool

  class WorkLogSearchTool(BaseTool):
      name = "work_log_search"
      description = """
      作業記録の検索・集計
      例: 「トマトの防除履歴」「7月の作業記録」「ダコニール使用履歴」
      """

      async def _run(self, query: str, user_id: str) -> dict:
          # 1. 検索クエリ解析
          search_params = await self._parse_search_query(query)

          # 2. データベース検索
          results = await self._search_work_logs(search_params, user_id)

          # 3. 結果集計・整形
          formatted = await self._format_search_results(results, query)

          return {
              "results": formatted,
              "total_count": len(results),
              "search_params": search_params
          }

  4. 自然言語処理ロジック

  4.1 情報抽出パターン

  防除作業の例:
  入力: "トマト桃太郎の防除3回目、ダコニール1000を1000倍で散布"
  抽出:
  - 作物名: "トマト"
  - 品種: "桃太郎"
  - 作業種別: "防除"
  - 回数: 3
  - 農薬名: "ダコニール1000"
  - 希釈倍率: "1000倍"

  施肥作業の例:
  入力: "キュウリハウスに追肥、NK化成20kg施用"
  抽出:
  - 作物名: "キュウリ"
  - 圃場: "キュウリハウス"
  - 作業種別: "施肥"
  - 肥料名: "NK化成"
  - 使用量: "20kg"

  4.2 抽出アルゴリズム

  1. 正規表現パターンマッチング
    - 作物名: 既知作物リストとの照合
    - 数値: 回数、量、倍率の抽出
    - 資材名: 登録農薬・肥料との照合
  2. LLM活用の意味解析
    - 文脈からの情報補完
    - 曖昧な表現の解釈
    - 作業種別の自動分類
  3. 信頼度スコアリング
    - 抽出情報の確度を0.0-1.0で評価
    - 低信頼度の場合は確認を促す

  5. 検索・呼び出し機能

  5.1 検索パターン

  時期別検索:
  - "7月の作業記録"
  - "先週の防除履歴"
  - "今月のトマト作業"

  作物別検索:
  - "トマトの防除履歴"
  - "キュウリの施肥記録"
  - "全作物の収穫量"

  資材別検索:
  - "ダコニール使用履歴"
  - "化成肥料の施用記録"

  作業別検索:
  - "防除回数の集計"
  - "収穫量の推移"
  - "異常報告一覧"

  5.2 出力フォーマット

  防除履歴の例:
  🌾 トマト桃太郎 防除履歴

  📅 7/20 (1回目)
  ・農薬: ダコニール1000 (1000倍)
  ・圃場: 第1ハウス

  📅 7/22 (2回目)
  ・農薬: モレスタン水和剤 (2000倍)
  ・圃場: 第1ハウス

  📅 7/24 (3回目)
  ・農薬: ダコニール1000 (1000倍)
  ・圃場: 第1ハウス

  📊 合計防除回数: 3回
  ⚠️ 次回推奨: 7/27 (異なる系統)

  6. エラーハンドリング・確認機能

  6.1 曖昧な情報の処理

  不明確な報告例:
  入力: "昨日畑に薬撒いた"
  システム:
  「詳細を教えてください：
  ・どちらの圃場ですか？
  ・どの作物に対してですか？
  ・どの農薬を使用しましたか？」

  6.2 確認・修正機能

  システム: 「以下の内容で記録しますか？
  📅 日付: 2025/7/24
  🌾 作物: トマト桃太郎
  🏠 圃場: 第1ハウス
  💊 作業: 防除 (3回目)
  💊 農薬: ダコニール1000

  修正がある場合は教えてください。」

  7. 実装手順

  7.1 Phase 1: 基本機能

  1. WorkLogRegistrationTool実装
  2. work_logs コレクション作成
  3. 基本的な情報抽出ロジック

  7.2 Phase 2: 検索機能

  1. WorkLogSearchTool実装
  2. 検索クエリ解析ロジック
  3. 結果フォーマット機能

  7.3 Phase 3: 高度化

  1. 信頼度ベース確認機能
  2. 作業パターン学習
  3. 異常検知・アラート

  8. 技術的考慮事項

  8.1 データ整合性

  - 重複記録の防止
  - 日付・時刻の正規化
  - 農薬・肥料名の標準化

  8.2 パフォーマンス

  - インデックス設計（日付、作物、作業種別）
  - 大量データ検索の最適化
  - キャッシュ戦略

  8.3 拡張性

  - 新しい作業種別の追加
  - カスタム分類の対応
  - 外部システム連携準備