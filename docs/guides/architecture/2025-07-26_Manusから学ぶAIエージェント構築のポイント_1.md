
# 2025-07-26 AIエージェント作成のポイント：Manus開発者からの教訓

## はじめに

AIエージェントの開発は、単なるプロンプトエンジニアリングを超えた複雑な技術領域です。特に自律的に動作し、複数のツールを使いこなすエージェントの設計には、従来のAIアプリケーション開発とは異なるアプローチが必要です。

本記事では、先進的なAIエージェントプラットフォーム「Manus」の開発チームが公開した技術記事「Context Engineering for AI Agents: Lessons from Building Manus」から得られた重要な知見を紹介します。4回のフレームワーク再構築と数百万ユーザーでの実世界テストを通じて学んだ、実践的な教訓をまとめました。

## 本文

### 1. KV-Cache最適化：パフォーマンスとコスト効率の要

KV-Cache（Key-Value Cache）は、AIモデルが以前に処理した情報を記憶しておく仕組みです。これを最適化することで、処理速度の向上とAPI呼び出しコストの削減が可能になります。

最適化のポイント：

•プロンプトの安定性を保つ：システムプロンプトの構造を一定に保ち、固定情報は同じ位置に配置する

•追記専用のコンテキスト設計：過去の情報を変更せず、新しい情報は常に末尾に追加する

•キャッシュブレークポイントの戦略的配置：システムプロンプト終了位置や大きなタスクの区切りに設定する

従来のアプローチでは、コンテキストウィンドウ内の情報を頻繁に書き換えていましたが、これはKV-Cacheの効率を大幅に低下させます。Manusの開発者は、「一度書いたら変更しない」原則を採用し、情報の追加は常に末尾に行うことで、キャッシュヒット率を最大化しています。

### 2. 賢いツール管理：削除ではなくマスキング手法

AIエージェントが使用するツール（関数）の管理方法も重要です。従来のアプローチでは、状況に応じてツールを動的に追加・削除していましたが、これはキャッシュ無効化や参照エラーの原因となります。

Manusの革新的解決策：

•ステートマシンによる管理：ツールを削除せず、状態で使用可能性を制御する

•レスポンスプリフィル技術：Auto、Required、Specifiedの3モードでAIの応答を制御

•戦略的なツール命名：機能別プレフィックス（browser_、file_、search_など）で制御を容易に

特に重要なのは「ツールを削除しない」という考え方です。代わりに、ツールの可視性をコントロールすることで、AIが適切なタイミングで適切なツールを選択できるようにします。

### 3. ファイルシステム活用：無限のメモリとして

AIモデルのコンテキスト制限を超えた情報管理のために、ファイルシステムを「外部メモリ」として活用する手法も注目されています。

ファイルシステムの利点：

•永続的な保存：セッション間でデータを維持できる

•サイズ制限なし：モデルのコンテキスト制限を超えた情報を管理可能

•AIが直接読み書き可能：専用ツールを通じてファイルを操作できる

特に「todo.md」のようなタスク管理ファイルは、AIエージェントの作業進捗を視覚化し、長期的なタスクの実行を支援します。

### 4. 注意操作：リサイテーションによる集中力向上

「リサイテーション（復唱）」は、重要な情報を意図的に繰り返し参照することで、AIの注意を特定の内容に向ける技術です。

リサイテーションの効果：

•集中力の向上：人間と同様、AIも「やることリスト」により集中力が向上する

•タスクの優先順位付け：重要な情報を繰り返し参照することで、優先順位が明確になる

•長期的な一貫性の維持：複雑なタスクでも目標を見失わない

todo.mdファイルを定期的に参照させることで、AIエージェントはタスクの全体像を把握し、一貫した行動を取ることができます。

### 5. 実践的開発アプローチ：確率的勾配降下法

Manusの開発チームは、理論よりも実験を重視する「確率的勾配降下」開発法を採用しています。

開発のポイント：

•仮説と実験の繰り返し：小さな改善案を立て、迅速に実装し、実測で評価する

•段階的な複雑性の管理：シンプルなエージェントから始め、一つずつ機能を追加する

•避けるべき落とし穴：最初から完璧なシステムを作ろうとする、複数の新機能を同時に追加する

この方法は、「波に乗る船であれ」という開発哲学に基づいています。AIモデルの進歩に適応し、技術の波に乗り続けるための柔軟な設計を重視しています。

## まとめ

Manusの開発者から学ぶAIエージェント作成の5つの鍵：

1.KV-Cache最適化：プロンプト構造の安定化と追記専用設計でパフォーマンスを向上

2.賢いツール管理：削除ではなくマスキング手法で参照エラーを防止

3.ファイルシステム活用：無限のメモリとして構造化された情報を管理

4.リサイテーション技術：重要情報の繰り返し参照でAIの注意を制御

5.実践的開発アプローチ：小さな改善を積み重ねる確率的勾配降下法

これらの技術を組み合わせることで、より効率的で安定したAIエージェントの開発が可能になります。理論だけでなく、実践から学んだこれらの教訓は、AIエージェント開発の現場で直ちに活用できる貴重な知見です。

## 実践チェックリスト

システムプロンプトの構造を一定に保つ設計になっているか

ツールは削除せず、状態で制御する仕組みを導入しているか

todo.mdなどのファイルで進捗を視覚化しているか

重要情報を定期的に参照させる仕組みがあるか

小さな改善を迅速に実装・検証するプロセスを確立しているか

AIエージェント開発は日進月歩の分野です。常に最新の知見を取り入れながら、実践を通じて学び続けることが成功の鍵となるでしょう。

## 参考資料

•Context Engineering for AI Agents: Lessons from Building Manus ([https://manus.im/blog/Context-Engineering-for-AI-Agents-Lessons-from-Building-Manus](https://manus.im/blog/Context-Engineering-for-AI-Agents-Lessons-from-Building-Manus))

•How Tool Complexity Impacts AI Agents Selection Accuracy ([https://achan2013.medium.com/how-tool-complexity-impacts-ai-agents-selection-accuracy-a3b6280ddce5](https://achan2013.medium.com/how-tool-complexity-impacts-ai-agents-selection-accuracy-a3b6280ddce5))

•Building AI Agents: Best Practices ([https://www.productcompass.pm/p/building-ai-agents-best-practices](https://www.productcompass.pm/p/building-ai-agents-best-practices))

## アクションプラン

## AIエージェント開発 実践アクションプラン

この記事で示された5つの教訓は、高性能で安定したAIエージェントを開発するための重要な指針です。これらを実際の開発プロジェクトで実現するための具体的なステップを以下に示します。

### 1. KV-Cache最適化：プロンプトを「聖域化」する

**目的:** AIモデルの処理速度を上げ、APIコストを削減します。

**具体的なアクションプラン:**

1. **システムプロンプトのテンプレート化:**
    
    - AIエージェントの役割、性格、基本ルール、禁止事項などを定義した「基本プロンプト」を作成します。
        
    - この基本プロンプトは、常に会話の最初に、**完全に同じ形**で配置されるようにシステムを設計します。
        
2. **コンテキストの「追記専用」化:**
    
    - ユーザーからの指示やAIの応答、ツールの実行結果などの履歴を、過去に遡って**編集・削除しない**アーキテクチャを採用します。
        
    - 新しい情報は、常にコンテキストウィンドウの末尾に追加していくようにします。
        
3. **戦略的キャッシュブレークポイントの設計:**
    
    - システムプロンプトの直後など、キャッシュが効きやすいポイントを意図的に作ります。例えば、タスクの指示はシステムプロンプトの後に配置することで、システムプロンプト部分のキャッシュ利用を最大化します。
        

### 2. 賢いツール管理：「削除」ではなく「非表示（マスキング）」にする

**目的:** AIが状況に応じて不適切なツールを使おうとするエラーを防ぎ、動作の安定性を高めます。

**具体的なアクションプラン:**

1. **全ツールの事前定義:**
    
    - エージェントが使用する可能性のあるツール（関数）をすべてリストアップします。
        
    - `browser_search`, `file_write` のように、機能ごとに接頭辞（プレフィックス）をつけて命名し、管理しやすくします。
        
2. **ステートマシン（状態管理）の導入:**
    
    - エージェントの現在の状態（例：「情報収集中」「コーディング中」「タスク計画中」など）を管理する仕組みを作ります。
        
    - それぞれの状態で**使用可能なツール**をマッピングします。例えば、「情報収集中」は`browser_`系ツールのみ、「コーディング中」は`file_`系ツールのみ、といったルールを設けます。
        
3. **動的なプロンプト生成:**
    
    - AIにプロンプトを渡す際に、現在の状態に応じて**許可されたツールリストだけを提示**します。これにより、AIは利用できないツールをそもそも認識しなくなり（マスキング）、エラーを未然に防ぎます。
        

### 3. ファイルシステム活用：「外部脳」を持たせる

**目的:** AIモデルのコンテキストウィンドウの制限を超えて、大量の情報を永続的に扱えるようにします。

**具体的なアクションプラン:**

1. **基本的なファイル操作ツールの実装:**
    
    - 以下の基本機能を持つツール（関数）をAIに提供します。
        
        - `file_read(filepath)`: ファイルを読み込む
            
        - `file_write(filepath, content)`: ファイルに内容を書き込む（上書き）
            
        - `file_append(filepath, content)`: ファイルに内容を追記する
            
        - `list_files(directory)`: 指定された場所のファイル一覧を表示する
            
2. **タスク管理ファイル `todo.md` の運用:**
    
    - エージェントの初期プロンプトに「**まず `todo.md` を読み込み、タスクプランを立てなさい**」という指示を組み込みます。
        
    - タスクの進捗があれば、`todo.md` を更新するように指示します。これにより、AIは長期的なタスクでも文脈を見失わなくなります。
        

### 4. 注意操作：「重要事項の復唱（リサイテーション）」をさせる

**目的:** 複雑なタスクや長期的な対話の中で、AIが最も重要な目標や文脈を見失わないようにします。

**具体的なアクションプラン:**

1. **思考ループへの組み込み:**
    
    - AIが次の行動を決定する思考サイクルの最初に、「**`todo.md` を参照し、現在の全体目標と次のステップを確認しなさい**」という手順を強制的に組み込みます。
        
2. **自己評価と計画修正の指示:**
    
    - 一つのサブタスクが完了するごとに、「**計画（`todo.md`）と実行結果を比較し、計画を更新する必要があるか検討しなさい**」と促します。これにより、AI自身が軌道修正を行うようになります。
        

### 5. 実践的開発アプローチ：「実験と改善」を繰り返す

**目的:** 完璧な設計を待つのではなく、小さな成功を積み重ねて、現実的かつ迅速にエージェントを賢くします。

**具体的なアクションプラン:**

1. **「最小構成」からスタート:**
    
    - まずは、たった一つの機能（例：Web検索）しか持たない、最もシンプルなエージェントを作成します。
        
2. **「仮説→実装→テスト」サイクルの徹底:**
    
    - 「ファイル書き込み機能を追加すれば、長い文章の要約精度が上がるはずだ」のような**具体的な仮説**を立てます。
        
    - 一度に**一つの機能だけ**を追加し、その仮説が正しかったかをテストで検証します。
        
    - 結果を数値（成功率、コスト、時間など）で評価し、良ければ採用、悪ければ別の仮説を試します。
        
3. **チームのルール設定:**
    
    - 「**一度に複数の変更を加えない**」「**完璧を目指さず、まず動かす**」といった原則を開発チームの共通認識とします。